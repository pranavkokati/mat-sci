name: Tests

on:
  push:
    branches: [ main, develop, 'claude/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run unit tests
      run: |
        python tests/test_simulator.py

    - name: Run critical experiments (smoke test)
      run: |
        # Run with reduced sample sizes for CI speed
        python -c "
        import sys
        sys.path.insert(0, '.')

        # Quick validation that experiments run
        from assembly_net.experiments.critical_experiments import (
            experiment_isomorphic_failure,
            experiment_topology_vs_simple_stats,
        )

        # Smoke test with minimal samples
        print('Running smoke tests...')
        result1 = experiment_isomorphic_failure(num_attempts=10, seed=42)
        print('Isomorphic test passed')

        result2 = experiment_topology_vs_simple_stats(num_samples=20, seed=42)
        print('Topology vs simple stats test passed')

        print('All smoke tests passed!')
        "

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check Python syntax
      run: |
        python -m py_compile assembly_net/theory/definitions.py
        python -m py_compile assembly_net/data/validated_simulator.py
        python -m py_compile assembly_net/experiments/critical_experiments.py
        python -m py_compile tests/test_simulator.py
        echo "Syntax check passed"
